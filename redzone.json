// First, declare persistent variables
if (fib_high === 0) {
    fib_high = 0
    fib_low = 0
    above50 = false
    inRedZone = false
    hasResetAtZero = true
}

// Define periods as options
options.longPeriod = 200
options.shortPeriod = 55

// Get price data
var price = avg_ohlc(bar)

// Calculate highest high and lowest low over the period
var highestHigh = highest(price.high, options.longPeriod)
var lowestLow = lowest(price.low, options.longPeriod)

// Update persistent variables only when we have new extremes
if (highestHigh > fib_high || lowestLow < fib_low) {
    fib_high = highestHigh
    fib_low = lowestLow
}

// Calculate Fibonacci levels using persistent variables
var diff = fib_high - fib_low

var fib2618 = fib_high + (diff * 1.618)  // 261.8%
var fib1 = fib_high + diff               // 100%
var fib618 = fib_high - (diff * 0.382)   // 61.8%
var fib50 = fib_high - (diff * 0.500)    // 50%
var fib28 = fib_high - (diff * 0.78)     // 28%
var fib0 = fib_low                       // 0%

// Calculate EMAs for all fib levels
var wma_fib2618 = ema(fib2618, options.longPeriod)
var wma_fib1 = ema(fib1, options.longPeriod)
var wma_fib618 = ema(fib618, options.longPeriod)
var wma_fib50 = ema(fib50, options.longPeriod)
var wma_fib28 = ema(fib28, options.longPeriod)
var wma_fib0 = ema(fib0, options.longPeriod)

// Reset state when hitting 0 fib
if (price.close <= wma_fib0) {
    hasResetAtZero = true
    inRedZone = false
    above50 = false
}

// State management logic
if (hasResetAtZero) {
    if (price.close > wma_fib50) {
        above50 = true
        hasResetAtZero = false
    }
} else if (above50 && price.close <= wma_fib50) {
    inRedZone = true
    above50 = false
}

// Plot candles with color logic
candlestick({
    time: time,
    open: price.open,
    high: price.high,
    low: price.low,
    close: price.close,
    color: inRedZone ? 'red' :
           above50 && price.close >= wma_fib618 ? 'lightgreen' :
           above50 ? 'green' :
           price.close >= wma_fib2618 ? 'white' :
           price.close >= wma_fib1 ? 'orange' :
           price.close >= wma_fib50 ? 'green' :
           price.close >= wma_fib28 ? 'red' :
           price.close >= wma_fib0 ? 'magenta' : 'blue',
    title: "Price"
})

// Plot Fibonacci level moving averages
line(wma_fib2618, color="#FFFFFF", title="261.8%")
line(wma_fib1, color="#FFA500", title="100%")
line(wma_fib618, color="#32CD32", title="61.8%")
line(wma_fib50, color="#FF0000", title="50%")
line(wma_fib28, color="#FF00FF", title="28%")
area({
    time: time,
    value: wma_fib0,
    color: "rgba(0,0,255,0.2)",
    title: "0%"
})
cloudarea(wma_fib1, wma_fib2618, color='rgba(0,0,0,0.6)')  // Cloud fill at top
